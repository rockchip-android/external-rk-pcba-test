#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>


#include "OV8858_MIPI_priv.h"
#include "camsys_head.h"
#include "camera_test.h"

//==================================
//sensor setting
//==================================
#define SENSOR_I2C_ADDR					0x6c

#define REG_STREAM_ON					0x0100
#define REG_SOFTWARE_RST				0x0103
#define REG_SOFTWARE_RST_DATA			0x01
#define I2C_NR_ADR_BYTES                2
#define I2C_NR_DAT_BYTES                0x01

#define REG_CHIP_ID_H					0x300a
#define REG_CHIP_ID_M					0x300b
#define REG_CHIP_ID_L					0x300c

//=================================
#define SENSOR_I2C_NUM					3
#define SENSOR_I2C_RATE					100000
struct rk_sensor_reg {
	unsigned int reg;
	unsigned int val;
};


struct rk_sensor_reg Ov8858_sensor_test[] = {
	{0x0100 , 0x00 },
	{0x0100 , 0x00 },
	{0x0100 , 0x00 },
	{0x0100 , 0x00 },
	{0x0302 , 0x1e },
	{0x0303 , 0x00 },
	{0x0304 , 0x03 },
	{0x030e , 0x00 },
	{0x030f , 0x09 },
	{0x0312 , 0x01 },
	{0x031e , 0x0c },
	{0x3600 , 0x00 },
	{0x3601 , 0x00 },
	{0x3602 , 0x00 },
	{0x3603 , 0x00 },
	{0x3604 , 0x22 },
	{0x3605 , 0x30 },
	{0x3606 , 0x00 },
	{0x3607 , 0x20 },
	{0x3608 , 0x11 },
	{0x3609 , 0x28 },
    {0x360a , 0x00 },
	{0x360b , 0x06 },
	{0x360c , 0xdc },
    {0x360d , 0x40 },
	{0x360e , 0x0c },
    {0x360f , 0x20 },
	{0x3610 , 0x07 },
	{0x3611 , 0x20 },
	{0x3612 , 0x88 },
	{0x3613 , 0x80 },
	{0x3614 , 0x58 },
	{0x3615 , 0x00 },
	{0x3616 , 0x4a },
	{0x3617 , 0xb0 },
    {0x3618 , 0x56 },
	{0x3619 , 0x70 },
	{0x361a , 0x99 },
    {0x361b , 0x00 },
	{0x361c , 0x07 },
	{0x361d , 0x00 },
	{0x361e , 0x00 },
	{0x361f , 0x00 },
	{0x3638 , 0xff },
	{0x3633 , 0x0c },
	{0x3634 , 0x0c },
	{0x3635 , 0x0c },
	{0x3636 , 0x0c },
	{0x3645 , 0x13 },
	{0x3646 , 0x83 },
	{0x364a , 0x07 },
	{0x3015 , 0x01 },
	{0x3018, 0x32},
	{0x3020 , 0x93 },
	{0x3022 , 0x01 },
	{0x3031 , 0x0a },
	{0x3034 , 0x00 },
	{0x3106 , 0x01 },
	{0x3305 , 0xf1 },
	{0x3308 , 0x00 },
	{0x3309 , 0x28 },
	{0x330a , 0x00 },
	{0x330b , 0x20 },
    {0x330c , 0x00 },
	{0x330d , 0x00 },
	{0x330e , 0x00 },
	{0x330f , 0x40 },
	{0x3307 , 0x04 },
	{0x3500 , 0x00 },
	{0x3501 , 0x4d },
	{0x3502 , 0x40 },
	{0x3503 , 0x00 },
	{0x3505 , 0x80 },
	{0x3508 , 0x04 },
    {0x3509 , 0x00 },
	{0x350c , 0x00 },
	{0x350d , 0x80 },
	{0x3510 , 0x00 },
	{0x3511 , 0x02 },
	{0x3512 , 0x00 },
	{0x3700 , 0x18 },
	{0x3701 , 0x0c },
	{0x3702 , 0x28 },
	{0x3703 , 0x19 },
	{0x3704 , 0x14 },
	{0x3705 , 0x00 },
	{0x3706 , 0x35 },
	{0x3707 , 0x04 },
	{0x3708 , 0x24 },
	{0x3709 , 0x33 },
	{0x370a , 0x00 },
	{0x370b , 0xb5 },
	{0x370c , 0x04 },
	{0x3718 , 0x12 },
	{0x3719 , 0x31 },
	{0x3712 , 0x42 },
	{0x3714 , 0x24 },
	{0x371e , 0x19 },
	{0x371f , 0x40 },
	{0x3720 , 0x05 },
	{0x3721 , 0x05 },
	{0x3724 , 0x06 },
	{0x3725 , 0x01 },
	{0x3726 , 0x06 },
	{0x3728 , 0x05 },
	{0x3729 , 0x02 },
	{0x372a , 0x03 },
	{0x372b , 0x53 },
	{0x372c , 0xa3 },
	{0x372d , 0x53 },
	{0x372e , 0x06 },
	{0x372f , 0x10 },
	{0x3730 , 0x01 },
	{0x3731 , 0x06 },
	{0x3732 , 0x14 },
	{0x3733 , 0x10 },
	{0x3734 , 0x40 },
	{0x3736 , 0x20 },
	{0x373a , 0x05 },
	{0x373b , 0x06 },
	{0x373c , 0x0a },
	{0x373e , 0x03 },
	{0x3755 , 0x10 },
	{0x3758 , 0x00 },
	{0x3759 , 0x4c },
	{0x375a , 0x06 },
	{0x375b , 0x13 },
	{0x375c , 0x20 },
	{0x375d , 0x02 },
	{0x375e , 0x00 },
	{0x375f , 0x14 },
	{0x3768 , 0x22 },
	{0x3769 , 0x44 },
	{0x376a , 0x44 },
	{0x3761 , 0x00 },
	{0x3762 , 0x00 },
	{0x3763 , 0x00 },
	{0x3766 , 0xff },
	{0x376b , 0x00 },
	{0x3772 , 0x23 },
	{0x3773 , 0x02 },
	{0x3774 , 0x16 },
	{0x3775 , 0x12 },
	{0x3776 , 0x04 },
	{0x3777 , 0x00 },
	{0x3778 , 0x1b },
	{0x37a0 , 0x44 },
	{0x37a1 , 0x3d },
	{0x37a2 , 0x3d },
	{0x37a3 , 0x00 },
	{0x37a4 , 0x00 },
	{0x37a5 , 0x00 },
	{0x37a6 , 0x00 },
	{0x37a7 , 0x44 },
	{0x37a8 , 0x4c },
	{0x37a9 , 0x4c },
	{0x3760 , 0x00 },
	{0x376f , 0x01 },
	{0x37aa , 0x44 },
	{0x37ab , 0x2e },
	{0x37ac , 0x2e },
	{0x37ad , 0x33 },
	{0x37ae , 0x0d },
	{0x37af , 0x0d },
	{0x37b0 , 0x00 },
	{0x37b1 , 0x00 },
	{0x37b2 , 0x00 },
	{0x37b3 , 0x42 },
	{0x37b4 , 0x42 },
	{0x37b5 , 0x33 },
	{0x37b6 , 0x00 },
	{0x37b7 , 0x00 },
	{0x37b8 , 0x00 },
	{0x37b9 , 0xff },
	{0x3800 , 0x00 },
	{0x3801 , 0x0c },
	{0x3802 , 0x00 },
	{0x3803 , 0x0c },
	{0x3804 , 0x0c },
	{0x3805 , 0xd3 },
	{0x3806 , 0x09 },
	{0x3807 , 0xa3 },
	{0x3808 , 0x06 },
	{0x3809 , 0x60 },
	{0x380a , 0x04 },
	{0x380b , 0xc8 },
	{0x380c , 0x07 },
	{0x380d , 0x88 },
	{0x380e , 0x04 },
	{0x380f , 0xdc },
	{0x3810 , 0x00 },
	{0x3811 , 0x04 },
	{0x3813 , 0x02 },
	{0x3814 , 0x03 },
	{0x3815 , 0x01 },
	{0x3820 , 0x00 },
	{0x3821 , 0x67 },
	{0x382a , 0x03 },
	{0x382b , 0x01 },
	{0x3830 , 0x08 },
	{0x3836 , 0x02 },
	{0x3837 , 0x18 },
	{0x3841 , 0xff },
	{0x3846 , 0x48 },
	{0x3d85 , 0x14 },
	{0x3f08 , 0x08 },
	{0x3f0a , 0x80 },
	{0x4000 , 0xf1 },
	{0x4001 , 0x10 },
	{0x4005 , 0x10 },
	{0x4002 , 0x27 },
	{0x4009 , 0x81 },
	{0x400b , 0x0c },
	{0x401b , 0x00 },
	{0x401d , 0x00 },
	{0x4020 , 0x00 },
	{0x4021 , 0x04 },
	{0x4022 , 0x04 },
	{0x4023 , 0xb9 },
	{0x4024 , 0x05 },
	{0x4025 , 0x2a },
	{0x4026 , 0x05 },
	{0x4027 , 0x2b },
	{0x4028 , 0x00 },
	{0x4029 , 0x02 },
	{0x402a , 0x04 },
	{0x402b , 0x04 },
	{0x402c , 0x02 },
	{0x402d , 0x02 },
	{0x402e , 0x08 },
	{0x402f , 0x02 },
	{0x401f , 0x00 },
	{0x4034 , 0x3f },
	{0x403d , 0x04 },
	{0x4300 , 0xff },
	{0x4301 , 0x00 },
	{0x4302 , 0x0f },
	{0x4316 , 0x00 },
	{0x4500 , 0x38 },
	{0x4503 , 0x18 },
	{0x4600 , 0x00 },
	{0x4601 , 0xcb },
	{0x481f , 0x32 },
	{0x4837 , 0x16 },
	{0x4850 , 0x10 },
	{0x4851 , 0x32 },
	{0x4b00 , 0x2a },
	{0x4b0d , 0x00 },
	{0x4d00 , 0x04 },
	{0x4d01 , 0x18 },
	{0x4d02 , 0xc3 },
	{0x4d03 , 0xff },
	{0x4d04 , 0xff },
	{0x4d05 , 0xff },
	{0x5000 , 0x7e },
	{0x5001 , 0x01 },
	{0x5002 , 0x08 },
	{0x5003 , 0x20 },
	{0x5046 , 0x12 },
	{0x5901 , 0x00 },
	{0x5e00 , 0x00 },
	{0x5e01 , 0x41 },
	{0x382d , 0x7f },
	{0x4825 , 0x3a },
	{0x4826 , 0x40 },
    {0x4808 , 0x25 }, 
    {0x380e , 0x04 }, 
	{0x380f , 0xdc }, 
	{0x0000 , 0x00 } 
};


int Ov8858_sensor_reg_init(int camsys_fd,unsigned int *i2cbase)
{
    int err,i2cbytes,i;
    struct rk_sensor_reg *sensor_reg;
    unsigned char *i2cchar;
    camsys_sysctrl_t sysctl;    
    camsys_i2c_info_t i2cinfo;
    int id;
    int size;

    i2cinfo.bus_num = SENSOR_I2C_NUM;
    i2cinfo.slave_addr = SENSOR_I2C_ADDR;
    i2cinfo.reg_addr = REG_SOFTWARE_RST;
    i2cinfo.reg_size = I2C_NR_ADR_BYTES; 
    i2cinfo.val = REG_SOFTWARE_RST_DATA;
    i2cinfo.val_size = I2C_NR_DAT_BYTES;
    i2cinfo.i2cbuf_directly = 0;
    i2cinfo.speed = SENSOR_I2C_RATE;
       
    err = ioctl(camsys_fd, CAMSYS_I2CWR, &i2cinfo);
    if (err<0) {
        printf("CAMSYS_I2CWR failed\n");
    } else {
        printf("I2c write: 0x%x : 0x%x\n",i2cinfo.reg_addr,i2cinfo.val);
    }
	printf("%s %d  hcc\n",__FUNCTION__,__LINE__);  

    usleep(20000);    
    
    i2cinfo.reg_addr = REG_CHIP_ID_H;
    i2cinfo.val_size = 0x01;       
    err = ioctl(camsys_fd, CAMSYS_I2CRD, &i2cinfo);
    if (err<0) {
        printf("CAMSYS_I2CRD failed\n");
    } else {
        printf("I2c read: 0x%x : 0x%x\n",i2cinfo.reg_addr,i2cinfo.val);
        id = (i2cinfo.val<<16);
    }
	
    i2cinfo.reg_addr = REG_CHIP_ID_M;
    err = ioctl(camsys_fd, CAMSYS_I2CRD, &i2cinfo);
    if (err<0) {
        printf("CAMSYS_I2CRD failed\n");
    } else {
        printf("I2c read: 0x%x : 0x%x\n",i2cinfo.reg_addr,i2cinfo.val);
        id = id|(i2cinfo.val<<8);
    }   
    i2cinfo.reg_addr = REG_CHIP_ID_L;
    err = ioctl(camsys_fd, CAMSYS_I2CRD, &i2cinfo);
    if (err<0) {
        printf("CAMSYS_I2CRD failed\n");
    } else {
        printf("I2c read: 0x%x : 0x%x\n",i2cinfo.reg_addr,i2cinfo.val);
        id |= i2cinfo.val;
    }

    printf("\n!!!!!!!!!!Sensor ID: 0x%x!!!!!!!!!!\n",id);
    
    i2cchar = (unsigned char*)i2cbase;

	sensor_reg = Ov8858_sensor_test;
	size = sizeof(Ov8858_sensor_test)/sizeof(struct rk_sensor_reg);

    i2cbytes = 0x00;
    for (i=0; i<size; i++) {
        *i2cchar++ = (sensor_reg->reg&0xff00)>>8; 
        *i2cchar++ = (sensor_reg->reg&0xff);
        *i2cchar++ = (sensor_reg->val&0xff);
        sensor_reg++;
        i2cbytes += 3;
    }
    printf("i2cbytes(%d)\n",i2cbytes);

    i2cinfo.bus_num = SENSOR_I2C_NUM;
    i2cinfo.slave_addr = SENSOR_I2C_ADDR;
    i2cinfo.i2cbuf_directly = 1;
    i2cinfo.i2cbuf_bytes = ((3<<16)|i2cbytes);
    i2cinfo.speed = SENSOR_I2C_RATE;
    err = ioctl(camsys_fd, CAMSYS_I2CWR, &i2cinfo);
    if (err<0) {
        printf("CAMSYS_I2CWR buf failed\n"); 
    }
    return err;
}
int Ov8858_sensor_streamon(int camsys_fd,unsigned int on)
{
    int err,i2cbytes,i;
    struct rk_sensor_reg *sensor_reg;
    camsys_sysctrl_t sysctl;    
    camsys_i2c_info_t i2cinfo;
    int id;

    i2cinfo.bus_num = SENSOR_I2C_NUM;
    i2cinfo.slave_addr = SENSOR_I2C_ADDR;
    i2cinfo.reg_addr = REG_STREAM_ON;
    i2cinfo.reg_size = 2; 
    i2cinfo.val = on;
    i2cinfo.val_size = I2C_NR_DAT_BYTES;
    i2cinfo.i2cbuf_directly = 0;
    i2cinfo.speed = SENSOR_I2C_RATE;
       
    err = ioctl(camsys_fd, CAMSYS_I2CWR, &i2cinfo);
    if (err < 0) {
        printf("extdev_streamon failed!\n");
    }
    printf("Sensor stream on : %d\n",on);
    
    return err;
}

int Ov8858_get_SensorInfo(rk_camera_info_t *rk_camera_info)
{
	//rk_camera_info_t rk_camera_info;
	//rk_camera_info->Camsys_Teset_Driver_Version = "Camsys_Test_OV8858_v(0x0,0,1.0)";
	//rk_camera_info->sensor_name     = "OV8858";

	rk_camera_info->phy_type		= CamSys_Phy_Mipi; //cif:CamSys_Phy_Cif mipi:CamSys_Phy_Mipi
	rk_camera_info->lane_num		= 2; //values:1,2,4
	rk_camera_info->bit_rate		= 720; //lane_num(1):720, lane_num(2):328, lane_num(4):408
	rk_camera_info->phy_index		= 0x0; //Rx/Tx:0x1 Rx:0x0
	rk_camera_info->mipi_img_data_sel = 0x2b; //cif:0x2c mipi:0x2b
	rk_camera_info->cif_num			= 0;
	rk_camera_info->fmt				= CamSys_Fmt_Raw_12b;
	rk_camera_info->cifio			= CamSys_SensorBit0_CifBit4;

	rk_camera_info->width			= 1632;
	rk_camera_info->height			= 1224;

	rk_camera_info->Mode			= RGB_BAYER;
	rk_camera_info->YCSequence		= CbYCrY;		   
	rk_camera_info->Conv422 		= Y0Cb0Y1Cr1;
	rk_camera_info->BPat			= BGBGGRGR ;
	rk_camera_info->HPol			= HPOL_HIGH;
	rk_camera_info->VPol			= VPOL_LOW;
	rk_camera_info->Edge			= SAMPLEEDGE_POS;
	//rk_camera_info->SmiaMode		= ISI_SMIA_OFF;
	//rk_camera_info->MipiMode		= ISI_MIPI_OFF;
	//rk_camera_info->SensorOutputMode = ISI_SENSOR_OUTPUT_MODE_YUV;

    rk_camera_info->dev_id = CAMSYS_DEVID_SENSOR_1A; //back:CAMSYS_DEVID_SENSOR_1A front:CAMSYS_DEVID_SENSOR_1B

	strlcpy((char*)rk_camera_info->sensorname, "OV8858",sizeof(rk_camera_info->sensorname));
	strlcpy((char*)rk_camera_info->version, "0x1.0.0",sizeof(rk_camera_info->version));
	return 0;
}

